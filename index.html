<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem e-Tasmik & Rekod Al-Quran (Cloud + AI)</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Prop-types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; } 
        .loader { border: 4px solid #e2e8f0; border-top: 4px solid #475569; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .ai-text { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- KONFIGURASI ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwSwGhRotEtwmwMX8LVDLfdY5a034ZcGnRXQEJTREYm1SPIJ7oSj-vjsokXCGXPrIVF/exec"; 
        const apiKey = ""; 

        // --- SUPPRESS CONSOLE WARNINGS ---
        const originalConsoleError = console.error;
        console.error = (...args) => {
            if (typeof args[0] === 'string' && /defaultProps/.test(args[0])) return;
            originalConsoleError(...args);
        };

        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = Recharts;
        
        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Users = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const BarChart2 = (props) => <IconBase {...props}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const Filter = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
        const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconBase>;
        const Edit = (props) => <IconBase {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>;
        const ThumbsUp = (props) => <IconBase {...props}><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></IconBase>;
        const ThumbsDown = (props) => <IconBase {...props}><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>;

        // --- Helper Functions ---
        const calculateJuzuk = (page) => {
            if (!page || page < 1) return 0;
            if (page <= 21) return 1;
            const juzuk = Math.floor((page - 22) / 20) + 2;
            return juzuk > 30 ? 30 : juzuk;
        };

        const formatDate = (dateStr) => {
            if(!dateStr) return "-";
            try {
                return new Date(dateStr).toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
            } catch (e) { return dateStr; }
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const StatCard = ({ title, value, icon: Icon, color, subtitle }) => (
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center space-x-4">
                <div className={`p-3 rounded-full ${color} bg-opacity-10`}>
                    <Icon className={`w-6 h-6 ${color.replace('bg-', 'text-')}`} />
                </div>
                <div>
                    <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">{title}</p>
                    <h3 className="text-2xl font-bold text-slate-700">{value}</h3>
                    {subtitle && <p className="text-xs text-slate-400 mt-1">{subtitle}</p>}
                </div>
            </div>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('rekod');
            const [students, setStudents] = useState([]);
            const [logs, setLogs] = useState([]);
            const [notification, setNotification] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [isConfigured, setIsConfigured] = useState(false);

            // AI States
            const [aiCommentLoading, setAiCommentLoading] = useState(false);
            const [aiAnalysisLoading, setAiAnalysisLoading] = useState(false);
            const [aiAnalysisResult, setAiAnalysisResult] = useState(null);

            // Form States
            const [selectedYear, setSelectedYear] = useState('');
            const [selectedClass, setSelectedClass] = useState('');
            const [selectedStudentId, setSelectedStudentId] = useState('');
            const [currentRecord, setCurrentRecord] = useState({
                tahap: 'Iqra 1',
                halaman: '',
                juzuk: '',
                tarikh: new Date().toISOString().split('T')[0],
                masa: new Date().toLocaleTimeString('it-IT').slice(0,5),
                kualiti: 'Lancar',
                catatan: ''
            });

            // Edit State
            const [isEditing, setIsEditing] = useState(false);
            const [editingStudentId, setEditingStudentId] = useState(null);
            const [newStudentName, setNewStudentName] = useState('');
            const [newStudentYear, setNewStudentYear] = useState('');
            const [newStudentClass, setNewStudentClass] = useState('');
            const [searchQuery, setSearchQuery] = useState(''); // New state for search

            // Report Filter States
            const [reportFilterYear, setReportFilterYear] = useState('');
            const [reportFilterClass, setReportFilterClass] = useState('');
            const [reportFilterLevel, setReportFilterLevel] = useState('');

            // --- GEMINI API CALL ---
            const callGemini = async (prompt) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, tiada respons AI.";
                } catch (error) {
                    console.error("Gemini Error:", error);
                    return null;
                }
            };

            // --- AI Feature 1: Comment Generator ---
            const handleGenerateComment = async () => {
                if (!currentRecord.tahap || !currentRecord.kualiti) {
                    showNotify("Sila pilih Tahap dan Kualiti dahulu.", "error");
                    return;
                }
                setAiCommentLoading(true);
                const prompt = `Bertindak sebagai guru Al-Quran yang penyayang dan motivasi. Berikan satu ulasan pendek (maksimum 15 patah perkataan) dalam Bahasa Melayu untuk murid yang membaca ${currentRecord.tahap} pada muka surat/halaman ${currentRecord.halaman} dengan kualiti bacaan "${currentRecord.kualiti}". Berikan nasihat membina. Jangan guna tanda petik.`;
                
                const result = await callGemini(prompt);
                if (result) {
                    setCurrentRecord(prev => ({ ...prev, catatan: result.trim() }));
                    showNotify("Ulasan AI berjaya dijana!", "success");
                } else {
                    showNotify("Gagal menghubungi AI.", "error");
                }
                setAiCommentLoading(false);
            };

            // --- AI Feature 2: Student Analysis ---
            const handleAnalyzeStudent = async (student, history) => {
                setAiAnalysisLoading(true);
                setAiAnalysisResult(null); // Clear prev result
                
                const historyStr = history.slice(0, 5).map(h => `${formatDate(h.tarikh)}: ${h.tahap} (Kualiti: ${h.kualiti})`).join("\n");
                const prompt = `Analisis prestasi murid bernama ${student.name} (Tahun ${student.tahun}, Kelas ${student.kelas}) berdasarkan 5 rekod terkini:\n${historyStr}\n\nBerikan 3 poin ringkas dalam Bahasa Melayu: 1. Kekuatan, 2. Kelemahan/Fokus, 3. Kata Semangat. Format output: HTML list ringkas (<ul><li>...</li></ul>).`;

                const result = await callGemini(prompt);
                if (result) {
                    setAiAnalysisResult(result);
                } else {
                    showNotify("Gagal membuat analisis AI.", "error");
                }
                setAiAnalysisLoading(false);
            };

            // --- GOOGLE SHEETS INTEGRATION ---
            const cleanUrl = (url) => url ? url.trim() : "";

            const fetchData = async () => {
                const url = cleanUrl(GOOGLE_SCRIPT_URL);
                if(!url || url.includes("PASTE_URL")) {
                    setIsConfigured(false);
                    return;
                }
                setIsConfigured(true);
                setIsLoading(true);
                try {
                    const response = await fetch(`${url}?v=${Date.now()}`);
                    const data = await response.json();
                    if(data.status === 'success') {
                        const validStudents = data.students
                            .filter(s => s && s.name)
                            .map(s => ({
                                id: s.id || generateId(),
                                name: s.name,
                                tahun: s.tahun || '-', 
                                kelas: s.kelas || 'Tiada Kelas'
                            }));
                        
                        const uniqueStudents = Array.from(new Map(validStudents.map(s => [s.id, s])).values());
                        
                        const validLogs = data.logs.filter(l => l && l.studentId);
                        validLogs.sort((a, b) => {
                            const dateA = new Date(a.timestamp || a.tarikh);
                            const dateB = new Date(b.timestamp || b.tarikh);
                            return dateB - dateA; 
                        });

                        setStudents(uniqueStudents);
                        setLogs(validLogs);
                        showNotify("Data berjaya dimuat turun", "success");
                    } else {
                        throw new Error("Invalid data format");
                    }
                } catch (error) {
                    console.error("Error fetching data:", error);
                    showNotify("Gagal memuat data (Pastikan akses 'Anyone' aktif)", "error");
                } finally {
                    setIsLoading(false);
                }
            };

            const postData = async (payload) => {
                const url = cleanUrl(GOOGLE_SCRIPT_URL);
                try {
                    await fetch(url, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify(payload)
                    });
                    return { status: "success" };
                } catch (error) {
                    console.error("Error posting:", error);
                    return { status: "error" };
                }
            };

            useEffect(() => { fetchData(); }, []);

            // Logic Lists
            const yearList = useMemo(() => [...new Set(students.map(s => s.tahun))].filter(Boolean).sort(), [students]);
            
            const classList = useMemo(() => {
                let filtered = students;
                if (selectedYear) filtered = filtered.filter(s => s.tahun === selectedYear);
                return [...new Set(filtered.map(s => s.kelas))].filter(Boolean).sort();
            }, [students, selectedYear]);

            // Report Filter Lists
            const reportYearList = useMemo(() => [...new Set(students.map(s => s.tahun))].filter(Boolean).sort(), [students]);
            const reportClassList = useMemo(() => {
                let filtered = students;
                if (reportFilterYear) filtered = filtered.filter(s => s.tahun === reportFilterYear);
                return [...new Set(filtered.map(s => s.kelas))].filter(Boolean).sort();
            }, [students, reportFilterYear]);

            const filteredStudents = useMemo(() => {
                return students.filter(s => 
                    (!selectedYear || s.tahun === selectedYear) && 
                    (!selectedClass || s.kelas === selectedClass)
                );
            }, [selectedYear, selectedClass, students]);

            const handlePageChange = (e) => {
                const page = parseInt(e.target.value);
                setCurrentRecord(prev => ({
                    ...prev,
                    halaman: page,
                    juzuk: currentRecord.tahap === 'Al-Quran' ? calculateJuzuk(page) : ''
                }));
            };

            const handleSubmitRecord = async (e) => {
                e.preventDefault();
                if (!selectedStudentId) return showNotify("Pilih murid dahulu", "error");

                setIsLoading(true);
                const newLog = {
                    id: generateId(),
                    studentId: selectedStudentId,
                    ...currentRecord,
                    timestamp: new Date().toISOString()
                };

                setLogs([newLog, ...logs]);

                const payload = { action: "addLog", ...newLog };
                await postData(payload);
                setIsLoading(false);
                showNotify("Rekod disimpan!", "success");
                
                setCurrentRecord(prev => ({ ...prev, halaman: '', juzuk: '', catatan: '' }));
                setAiAnalysisResult(null); // Clear analysis on new submission
            };

            // --- Student Management Logic ---
            const handleEditClick = (student) => {
                setNewStudentName(student.name);
                setNewStudentYear(student.tahun);
                setNewStudentClass(student.kelas);
                setEditingStudentId(student.id);
                setIsEditing(true);
                document.getElementById('studentForm').scrollIntoView({ behavior: 'smooth' });
            };

            const cancelEdit = () => {
                setIsEditing(false);
                setEditingStudentId(null);
                setNewStudentName('');
                setNewStudentYear('');
                setNewStudentClass('');
            };

            const handleAddOrUpdateStudent = async () => {
                if (!newStudentName || !newStudentYear || !newStudentClass) return showNotify("Sila isi semua maklumat", "error");
                setIsLoading(true);

                if (isEditing && editingStudentId) {
                    const updatedStudent = { id: editingStudentId, name: newStudentName, tahun: newStudentYear, kelas: newStudentClass };
                    setStudents(students.map(s => s.id === editingStudentId ? updatedStudent : s));
                    await postData({ action: "editStudent", ...updatedStudent });
                    showNotify("Maklumat murid dikemaskini", "success");
                    cancelEdit();
                } else {
                    const existingStudent = students.find(s => s.name.toLowerCase() === newStudentName.toLowerCase());
                    if (existingStudent) {
                        if(!confirm("Nama murid sudah wujud. Adakah anda mahu mengemaskini data murid ini?")) { setIsLoading(false); return; }
                        const studentData = { id: existingStudent.id, name: existingStudent.name, tahun: newStudentYear, kelas: newStudentClass };
                        setStudents(students.map(s => s.id === existingStudent.id ? studentData : s));
                        await postData({ action: "editStudent", ...studentData });
                        showNotify("Data murid dikemaskini", "success");
                    } else {
                        const studentData = { id: generateId(), name: newStudentName, tahun: newStudentYear, kelas: newStudentClass };
                        setStudents([...students, studentData]);
                        await postData({ action: "addStudent", ...studentData });
                        showNotify("Murid ditambah", "success");
                    }
                    setNewStudentName(''); setNewStudentYear(''); setNewStudentClass('');
                }
                setIsLoading(false);
            };

            const handleDeleteStudent = async (id) => {
                if(!confirm("Adakah anda pasti mahu memadam murid ini?")) return;
                setStudents(students.filter(s => s.id !== id));
                setLogs(logs.filter(l => l.studentId !== id));
                await postData({ action: "deleteStudent", id: id });
                showNotify("Murid berjaya dipadam", "success");
            };

            // --- CSV Upload Logic ---
            const handleCSVUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsLoading(true);
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n').slice(1); 
                    const studentsToProcess = [];
                    const studentMap = new Map(students.map(s => [s.name.toLowerCase(), s.id]));
                    for(let row of rows) {
                        const cols = row.split(',');
                        if(cols.length >= 3) { 
                            const name = cols[0].trim();
                            const tahun = cols[1].trim();
                            const kelas = cols[2].trim();
                            if(name && tahun && kelas) {
                                let studentId;
                                const nameKey = name.toLowerCase();
                                if (studentMap.has(nameKey)) { studentId = studentMap.get(nameKey); } else { studentId = generateId(); studentMap.set(nameKey, studentId); }
                                studentsToProcess.push({ id: studentId, name, tahun, kelas });
                            }
                        }
                    }
                    if (studentsToProcess.length === 0) { setIsLoading(false); showNotify("Tiada data sah.", "error"); return; }
                    const newStudentState = [...students];
                    for(const p of studentsToProcess) {
                        const idx = newStudentState.findIndex(s => s.id === p.id);
                        if(idx > -1) newStudentState[idx] = p; else newStudentState.push(p);
                        await postData({ action: "addStudent", ...p });
                    }
                    setStudents(newStudentState);
                    setIsLoading(false);
                    showNotify(`${studentsToProcess.length} data diproses!`, "success");
                    e.target.value = null;
                };
                reader.readAsText(file);
            };

            const generateIndividualPDF = (student) => {
                const doc = new jspdf.jsPDF();
                const studentLogs = logs.filter(l => l.studentId === student.id).sort((a,b) => new Date(a.tarikh) - new Date(b.tarikh));
                doc.setFontSize(18); doc.text(`Laporan: ${student.name}`, 14, 20);
                doc.setFontSize(12); doc.text(`Tahun: ${student.tahun} | Kelas: ${student.kelas}`, 14, 30);
                const tableData = studentLogs.map(log => [formatDate(log.tarikh), log.tahap, log.tahap === 'Al-Quran' ? `Juz ${log.juzuk} (Hlm ${log.halaman})` : log.halaman || '-', log.kualiti, log.catatan]);
                doc.autoTable({ startY: 45, head: [['Tarikh', 'Tahap', 'Bacaan', 'Kualiti', 'Catatan']], body: tableData, theme: 'grid' });
                doc.save(`Laporan_${student.name}.pdf`);
            };

            const generateFullReportPDF = () => {
                const doc = new jspdf.jsPDF();
                doc.setFontSize(18);
                let title = "Laporan Prestasi Al-Quran";
                if (reportFilterYear) title += ` - Tahun ${reportFilterYear}`;
                if (reportFilterClass) title += ` (${reportFilterClass})`;
                doc.text(title, 14, 20);
                doc.setFontSize(10);
                doc.text(`Tarikh Cetakan: ${new Date().toLocaleDateString('ms-MY')}`, 14, 28);
                let targets = students;
                if (reportFilterYear) targets = targets.filter(s => s.tahun === reportFilterYear);
                if (reportFilterClass) targets = targets.filter(s => s.kelas === reportFilterClass);
                const tableData = [];
                targets.forEach(student => {
                    const lastLog = logs.find(l => l.studentId === student.id); 
                    const currentTahap = lastLog ? lastLog.tahap : 'Tiada Rekod';
                    let include = true;
                    if (reportFilterLevel) {
                         if (reportFilterLevel === 'Iqra' && !currentTahap.startsWith('Iqra')) include = false;
                         else if (reportFilterLevel === 'Al-Quran' && currentTahap !== 'Al-Quran') include = false;
                         else if (reportFilterLevel === 'Khatam' && currentTahap !== 'Khatam') include = false;
                         if (currentTahap === 'Tiada Rekod') include = false;
                    }
                    if (include) {
                        tableData.push([
                            student.name, student.tahun, student.kelas, currentTahap,
                            (lastLog && lastLog.tahap === 'Al-Quran') ? `Juzuk ${lastLog.juzuk}` : (lastLog && lastLog.tahap.startsWith('Iqra')) ? `Halaman ${lastLog.halaman}` : '-'
                        ]);
                    }
                });
                tableData.sort((a, b) => a[0].localeCompare(b[0]));
                if (tableData.length === 0) { showNotify("Tiada rekod ditemui.", "error"); return; }
                doc.autoTable({ startY: 35, head: [['Nama Murid', 'Tahun', 'Kelas', 'Tahap Terkini', 'Pencapaian']], body: tableData, theme: 'grid', headStyles: { fillColor: [51, 65, 85] }, styles: { fontSize: 10 } });
                doc.save(`Laporan_Prestasi_${new Date().toISOString().split('T')[0]}.pdf`);
            };

            const showNotify = (msg, type) => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const getLatestLog = (studentId) => logs.find(l => l.studentId === studentId);
            
            // --- STATS LOGIC ---
            const stats = useMemo(() => {
                let targetStudents = students;

                if (reportFilterYear) targetStudents = targetStudents.filter(s => s.tahun === reportFilterYear);
                if (reportFilterClass) targetStudents = targetStudents.filter(s => s.kelas === reportFilterClass);

                let totalStudents = 0;
                const byTahap = { 'Iqra 1': 0, 'Iqra 2': 0, 'Iqra 3': 0, 'Iqra 4': 0, 'Iqra 5': 0, 'Iqra 6': 0, 'Al-Quran': 0, 'Khatam': 0 };
                const juzukDist = Array(30).fill(0);

                targetStudents.forEach(s => {
                    const log = getLatestLog(s.id);
                    if (log) {
                        let matchLevel = true;
                        if (reportFilterLevel) {
                            if (reportFilterLevel === 'Iqra' && !log.tahap.startsWith('Iqra')) matchLevel = false;
                            else if (reportFilterLevel === 'Al-Quran' && log.tahap !== 'Al-Quran') matchLevel = false;
                            else if (reportFilterLevel === 'Khatam' && log.tahap !== 'Khatam') matchLevel = false;
                        }
                        if (matchLevel) {
                            totalStudents++; 
                            if (log.tahap.startsWith('Iqra')) { if (byTahap[log.tahap] !== undefined) byTahap[log.tahap]++; }
                            else if (log.tahap === 'Al-Quran') { byTahap['Al-Quran']++; if(log.juzuk > 0 && log.juzuk <= 30) juzukDist[log.juzuk - 1]++; }
                            else if (log.tahap === 'Khatam') { byTahap['Khatam']++; }
                        }
                    } else if (!reportFilterLevel) { totalStudents++; }
                });

                // --- KPI LOGIC ---
                const passLevels = ['Iqra 4', 'Iqra 5', 'Iqra 6', 'Al-Quran', 'Khatam'];
                const failLevels = ['Iqra 1', 'Iqra 2', 'Iqra 3'];
                let countPass = 0;
                let countFail = 0;
                let kpiDenominator = 0; // Count of students in Year 2-6 within the filter

                targetStudents.forEach(s => {
                    const match = s.tahun.toString().match(/(\d+)/);
                    const y = match ? parseInt(match[0]) : NaN;
                    const isTargetYear = !isNaN(y) && y >= 2 && y <= 6;

                    if (isTargetYear) {
                        kpiDenominator++; // Only add to denominator if Year 2-6
                        const log = getLatestLog(s.id);
                        if (log) {
                            if (passLevels.includes(log.tahap)) countPass++;
                            else if (failLevels.includes(log.tahap)) countFail++;
                        }
                    }
                });

                const percentPass = kpiDenominator > 0 ? ((countPass / kpiDenominator) * 100).toFixed(1) : "0.0";
                const percentFail = kpiDenominator > 0 ? ((countFail / kpiDenominator) * 100).toFixed(1) : "0.0";

                return { 
                    totalStudents, 
                    dataByTahap: Object.keys(byTahap).map(k => ({ name: k, value: byTahap[k] })),
                    dataByJuzuk: juzukDist.map((c, i) => ({ juzuk: `J${i+1}`, count: c })),
                    kpi: { pass: countPass, fail: countFail, total: kpiDenominator, pPass: percentPass, pFail: percentFail }
                };
            }, [students, logs, reportFilterClass, reportFilterYear, reportFilterLevel]);

            if (!isConfigured) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 flex-col p-8 text-center">
                        <AlertCircle className="w-16 h-16 text-slate-400 mb-4" />
                        <h1 className="text-2xl font-bold text-slate-800 mb-2">Konfigurasi Diperlukan</h1>
                        <p className="text-slate-600 max-w-lg mb-6">Sila paste URL Google Apps Script anda ke dalam kod pada baris <code>const GOOGLE_SCRIPT_URL</code>.</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-10 relative text-slate-800">
                    {isLoading && (
                        <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white p-4 rounded-lg shadow-xl flex items-center space-x-3">
                                <div className="loader"></div>
                                <span className="font-medium text-slate-700">Sedang Memproses...</span>
                            </div>
                        </div>
                    )}

                    {notification && (
                        <div className={`fixed top-5 right-5 px-6 py-3 rounded-lg shadow-lg z-50 text-white flex items-center space-x-2 animate-fade-in-down ${notification.type === 'error' ? 'bg-red-500' : 'bg-slate-700'}`}>
                            {notification.type === 'error' ? <AlertCircle size={20}/> : <CheckCircle size={20}/>}
                            <span>{notification.msg}</span>
                        </div>
                    )}

                    <nav className="bg-slate-800 text-white shadow-md sticky top-0 z-40 border-b border-slate-700">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center space-x-3">
                                    <BookOpen className="h-8 w-8 text-slate-300" />
                                    <div>
                                        <span className="font-bold text-xl block leading-none tracking-tight">e-Tasmik</span>
                                        <span className="text-xs text-slate-400 flex items-center gap-1 mt-0.5"><Cloud size={10}/> Cloud Sync Active</span>
                                    </div>
                                </div>
                                <div className="flex space-x-2">
                                    {[{ id: 'rekod', label: 'Rekod', icon: FileText }, { id: 'murid', label: 'Murid', icon: Users }, { id: 'laporan', label: 'Laporan', icon: BarChart2 }].map(tab => (
                                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 ${activeTab === tab.id ? 'bg-slate-700 text-white shadow-sm border border-slate-600' : 'text-slate-400 hover:bg-slate-700 hover:text-slate-200'}`}>
                                            <tab.icon size={16} /> <span className="hidden md:inline">{tab.label}</span>
                                        </button>
                                    ))}
                                    <button onClick={fetchData} className="ml-2 bg-slate-700 p-2 rounded border border-slate-600 text-slate-400 hover:text-white hover:border-slate-500 transition-colors" title="Refresh Data"><Cloud size={18}/></button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
                        {/* ... (Tabs Rekod & Murid Logic omitted for brevity, logic is identical to previous) ... */}
                        
                        {activeTab === 'rekod' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-1 space-y-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                        <h2 className="text-lg font-bold text-slate-800 mb-5 flex items-center border-b pb-3 border-slate-100">
                                            <Users className="mr-2 text-slate-600" size={20}/> Pilih Murid
                                        </h2>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide">Tahun</label>
                                                <select value={selectedYear} onChange={(e) => { setSelectedYear(e.target.value); setSelectedClass(''); setSelectedStudentId(''); }} className="w-full bg-slate-50 border-slate-300 rounded-md shadow-sm border p-2.5 focus:ring-2 focus:ring-slate-500 transition-shadow text-slate-700">
                                                    <option value="">-- Pilih Tahun --</option>
                                                    {yearList.map(y => <option key={y} value={y}>{y}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide">Kelas</label>
                                                <select value={selectedClass} onChange={(e) => { setSelectedClass(e.target.value); setSelectedStudentId(''); }} disabled={!selectedYear} className="w-full bg-slate-50 border-slate-300 rounded-md shadow-sm border p-2.5 disabled:bg-slate-100 disabled:text-slate-400 text-slate-700 transition-shadow">
                                                    <option value="">-- Pilih Kelas --</option>
                                                    {classList.map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide">Nama Murid</label>
                                                <select value={selectedStudentId} onChange={(e) => setSelectedStudentId(e.target.value)} disabled={!selectedClass} className="w-full bg-slate-50 border-slate-300 rounded-md shadow-sm border p-2.5 disabled:bg-slate-100 disabled:text-slate-400 text-slate-700 transition-shadow">
                                                    <option value="">-- Pilih Nama --</option>
                                                    {filteredStudents.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {selectedStudentId && (() => {
                                        const lastLog = getLatestLog(selectedStudentId);
                                        const curStudent = students.find(s => s.id === selectedStudentId);
                                        const studentHistory = logs.filter(l => l.studentId === selectedStudentId).slice(0, 10);

                                        return (
                                            <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 shadow-sm">
                                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-slate-200 pb-2">
                                                    {curStudent ? `${curStudent.name} (${curStudent.tahun} - ${curStudent.kelas})` : 'Status Terkini'}
                                                </h3>
                                                {lastLog ? (
                                                    <div className="space-y-3 text-sm">
                                                        <div className="flex justify-between items-center"><span className="text-slate-500">Tarikh Akhir</span> <span className="font-semibold text-slate-800">{formatDate(lastLog.tarikh)}</span></div>
                                                        <div className="flex justify-between items-center"><span className="text-slate-500">Tahap</span> <span className="px-2 py-0.5 bg-slate-200 rounded text-slate-700 font-semibold text-xs">{lastLog.tahap}</span></div>
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-slate-500">Halaman Terkini</span> 
                                                            <span className="font-semibold text-slate-800">
                                                                {lastLog.tahap === 'Al-Quran' ? `Juz ${lastLog.juzuk} / Hlm ${lastLog.halaman}` : `Halaman ${lastLog.halaman}`}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between items-center"><span className="text-slate-500">Kualiti</span> <span className="text-slate-800 italic">{lastLog.kualiti}</span></div>
                                                    </div>
                                                ) : <p className="text-slate-400 italic text-sm py-2 text-center">Tiada rekod bacaan sebelum ini.</p>}
                                                
                                                {/* AI ANALYSIS BUTTON */}
                                                <button 
                                                    onClick={() => handleAnalyzeStudent(curStudent, studentHistory)} 
                                                    disabled={aiAnalysisLoading || !lastLog}
                                                    className={`mt-6 w-full border py-2.5 rounded-lg text-sm font-semibold flex items-center justify-center shadow-sm transition-all ${aiAnalysisLoading ? 'bg-slate-100 text-slate-400' : 'bg-white border-indigo-300 text-indigo-600 hover:bg-indigo-50'}`}
                                                >
                                                    {aiAnalysisLoading ? (
                                                        <span>Menganalisis...</span>
                                                    ) : (
                                                        <><Sparkles className="w-4 h-4 mr-2 text-indigo-500"/> Analisis Prestasi AI</>
                                                    )}
                                                </button>

                                                {aiAnalysisResult && (
                                                    <div className="mt-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100 text-sm text-slate-700 animate-fade-in">
                                                        <div className="flex items-center mb-2"><Sparkles className="w-3 h-3 mr-2 text-indigo-500"/><span className="font-bold text-indigo-700">Rumusan AI:</span></div>
                                                        <div dangerouslySetInnerHTML={{ __html: aiAnalysisResult }} className="leading-relaxed ml-4" />
                                                    </div>
                                                )}

                                                <button onClick={() => generateIndividualPDF(curStudent)} className="mt-3 w-full bg-white border border-slate-300 text-slate-700 py-2.5 rounded-lg text-sm font-semibold hover:bg-slate-50 transition-all flex items-center justify-center shadow-sm">
                                                    <Download className="w-4 h-4 mr-2"/> Laporan Individu
                                                </button>
                                            </div>
                                        )
                                    })()}
                                </div>

                                <div className="lg:col-span-2">
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                        <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                                            <h2 className="text-lg font-bold text-slate-800 flex items-center">
                                                <FileText className="mr-2 text-slate-600"/> Borang Kemaskini
                                            </h2>
                                        </div>
                                        <form onSubmit={handleSubmitRecord} className="p-6 space-y-6">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Tahap Bacaan</label>
                                                    <select value={currentRecord.tahap} onChange={(e) => setCurrentRecord({...currentRecord, tahap: e.target.value})} className="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-2 focus:ring-slate-500 bg-slate-50 text-slate-700">
                                                        <optgroup label="Iqra">{[1,2,3,4,5,6].map(i => <option key={i} value={`Iqra ${i}`}>Iqra {i}</option>)}</optgroup>
                                                        <option value="Al-Quran">Al-Quran</option><option value="Khatam">Khatam</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{currentRecord.tahap === 'Al-Quran' ? 'Halaman' : 'Halaman / Muka Surat'}</label>
                                                    <input type={currentRecord.tahap === 'Al-Quran' ? "number" : "text"} value={currentRecord.halaman} onChange={handlePageChange} className="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-2 focus:ring-slate-500 bg-slate-50 text-slate-700" required placeholder="Masukkan muka surat..."/>
                                                    {currentRecord.tahap === 'Al-Quran' && currentRecord.juzuk && <p className="text-xs text-slate-500 mt-1 italic">Automatik: Juzuk {currentRecord.juzuk}</p>}
                                                </div>
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Tarikh</label><input type="date" value={currentRecord.tarikh} onChange={(e) => setCurrentRecord({...currentRecord, tarikh: e.target.value})} className="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-2 focus:ring-slate-500 bg-slate-50 text-slate-700"/></div>
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Masa</label><input type="time" value={currentRecord.masa} onChange={(e) => setCurrentRecord({...currentRecord, masa: e.target.value})} className="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-2 focus:ring-slate-500 bg-slate-50 text-slate-700"/></div>
                                                <div className="md:col-span-2">
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Kualiti Bacaan</label>
                                                    <div className="flex space-x-4">
                                                        {['Lancar', 'Sederhana', 'Merangkak'].map(k => (
                                                            <label key={k} className={`flex-1 border rounded-lg p-3 cursor-pointer text-center transition-all ${currentRecord.kualiti === k ? 'border-slate-600 bg-slate-700 text-white shadow-md' : 'border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                                                <input type="radio" name="kualiti" value={k} checked={currentRecord.kualiti === k} onChange={(e) => setCurrentRecord({...currentRecord, kualiti: e.target.value})} className="sr-only"/>
                                                                <span className="text-sm font-medium">{k}</span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                {/* AI COMMENT GENERATOR */}
                                                <div className="md:col-span-2 relative">
                                                    <div className="flex justify-between items-end mb-1">
                                                        <label className="block text-xs font-bold text-slate-500 uppercase">Catatan Guru</label>
                                                        <button 
                                                            type="button"
                                                            onClick={handleGenerateComment}
                                                            disabled={aiCommentLoading || !currentRecord.tahap}
                                                            className="text-xs flex items-center text-purple-600 hover:text-purple-800 font-semibold disabled:opacity-50"
                                                        >
                                                            <Sparkles className="w-3 h-3 mr-1"/> 
                                                            {aiCommentLoading ? "Menjana..." : "Auto-Ulasan AI"}
                                                        </button>
                                                    </div>
                                                    <textarea rows="2" value={currentRecord.catatan} onChange={(e) => setCurrentRecord({...currentRecord, catatan: e.target.value})} className="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-2 focus:ring-slate-500 bg-slate-50 text-slate-700" placeholder="Contoh: Perlu perbaiki makhraj..."></textarea>
                                                </div>
                                            </div>
                                            <div className="flex justify-end pt-4 border-t border-slate-100">
                                                <button type="submit" disabled={!selectedStudentId} className="bg-slate-800 text-white px-8 py-3 rounded-lg font-medium shadow hover:bg-slate-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                                                    <Save className="mr-2 w-5 h-5"/> Simpan
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Murid & Laporan Tabs (Same as before) */}
                        {activeTab === 'murid' && (
                            <div className="space-y-8">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                                    {/* Manual Registration Form */}
                                    <div id="studentForm" className={`p-8 rounded-xl shadow-sm border border-slate-200 flex flex-col transition-colors ${isEditing ? 'bg-yellow-50 border-yellow-200' : 'bg-white'}`}>
                                        <h3 className={`font-bold text-xl mb-6 flex items-center border-b pb-4 border-slate-100 ${isEditing ? 'text-yellow-800' : 'text-slate-800'}`}>
                                            <Users className={`w-6 h-6 mr-3 ${isEditing ? 'text-yellow-600' : 'text-slate-600'}`}/> 
                                            {isEditing ? 'Kemaskini Maklumat Murid' : 'Pendaftaran Manual'}
                                        </h3>
                                        <div className="flex-1 flex flex-col justify-between gap-5">
                                            <div className="space-y-4">
                                                <input type="text" placeholder="Nama Penuh Murid" value={newStudentName} onChange={(e) => setNewStudentName(e.target.value)} className="w-full border-slate-300 p-3 rounded-lg border bg-slate-50 focus:ring-2 focus:ring-slate-500 outline-none transition-all text-slate-700"/>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <input type="text" placeholder="Tahun (Contoh: 1)" value={newStudentYear} onChange={(e) => setNewStudentYear(e.target.value)} className="w-full border-slate-300 p-3 rounded-lg border bg-slate-50 focus:ring-2 focus:ring-slate-500 outline-none transition-all text-slate-700"/>
                                                    <input type="text" placeholder="Kelas (Contoh: Ibnu Sina)" value={newStudentClass} onChange={(e) => setNewStudentClass(e.target.value)} className="w-full border-slate-300 p-3 rounded-lg border bg-slate-50 focus:ring-2 focus:ring-slate-500 outline-none transition-all text-slate-700"/>
                                                </div>
                                            </div>
                                            <div className="flex gap-3 mt-4">
                                                <button onClick={handleAddOrUpdateStudent} className={`flex-1 text-white py-3 rounded-lg font-medium shadow-sm transition-colors ${isEditing ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                                    {isEditing ? 'Kemaskini' : 'Daftar Murid'}
                                                </button>
                                                {isEditing && (
                                                    <button onClick={cancelEdit} className="bg-slate-200 text-slate-600 px-6 py-3 rounded-lg font-medium hover:bg-slate-300">
                                                        Batal
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* CSV Upload */}
                                    <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                                        <h3 className="font-bold text-xl text-slate-800 mb-6 flex items-center border-b pb-4 border-slate-100">
                                            <Upload className="w-6 h-6 mr-3 text-slate-600"/> Import CSV
                                        </h3>
                                        <div className="flex-1 flex flex-col justify-between h-full">
                                            <div className="bg-slate-50 border border-dashed border-slate-300 rounded-lg p-6 text-center mb-4 flex-1 flex flex-col justify-center items-center">
                                                <FileText className="w-10 h-10 text-slate-400 mx-auto mb-3"/>
                                                <p className="text-sm text-slate-600 mb-1 font-medium">Muat naik fail .csv</p>
                                                <p className="text-xs text-slate-500">Format: <b>Nama, Tahun, Kelas</b></p>
                                            </div>
                                            <div className="relative flex justify-center">
                                                <label className="block w-full">
                                                    <span className="sr-only">Choose file</span>
                                                    <input 
                                                        type="file" 
                                                        accept=".csv" 
                                                        onChange={handleCSVUpload}
                                                        className="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-white hover:file:bg-slate-600 cursor-pointer border border-slate-200 rounded-lg bg-white shadow-sm"
                                                    />
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Students Table */}
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mt-6">
                                    <div className="p-5 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                                        <h3 className="font-bold text-slate-700">Direktori Murid</h3>
                                        <div className="flex items-center space-x-2">
                                            <div className="relative">
                                                <span className="absolute inset-y-0 left-0 flex items-center pl-2 text-slate-400">
                                                    <Search className="w-4 h-4"/>
                                                </span>
                                                <input 
                                                    type="text" 
                                                    placeholder="Carian Nama..." 
                                                    value={searchQuery}
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                    className="pl-8 pr-2 py-1.5 text-sm border-slate-300 rounded-md border focus:ring-1 focus:ring-slate-500 text-slate-700 w-40"
                                                />
                                            </div>
                                            <select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)} className="border-slate-300 rounded-md border p-1.5 text-sm bg-white focus:ring-1 focus:ring-slate-500 text-slate-700">
                                                <option value="">Semua Tahun</option>{yearList.map(y => <option key={y} value={y}>{y}</option>)}
                                            </select>
                                            <select value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)} className="border-slate-300 rounded-md border p-1.5 text-sm bg-white focus:ring-1 focus:ring-slate-500 text-slate-700">
                                                <option value="">Semua Kelas</option>{classList.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full divide-y divide-slate-200">
                                            <thead className="bg-slate-100">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Nama</th>
                                                    <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Tahun</th>
                                                    <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Kelas</th>
                                                    <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Tahap</th>
                                                    <th className="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Tindakan</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-slate-200">
                                                {filteredStudents
                                                    .filter(s => s.name.toLowerCase().includes(searchQuery.toLowerCase()))
                                                    .map((student) => { 
                                                    const lastLog = getLatestLog(student.id); 
                                                    return (
                                                        <tr key={student.id} className="hover:bg-slate-50 transition-colors">
                                                            <td className="px-6 py-4 font-medium text-xs text-slate-900">{student.name}</td>
                                                            <td className="px-6 py-4 text-xs text-slate-500">{student.tahun}</td>
                                                            <td className="px-6 py-4 text-xs text-slate-500">{student.kelas}</td>
                                                            <td className="px-6 py-4">
                                                                {lastLog ? <span className="px-2.5 py-1 text-xs font-semibold rounded-md bg-slate-100 text-slate-700 border border-slate-200">{lastLog.tahap} {lastLog.tahap === 'Al-Quran' ? `(J${lastLog.juzuk})` : ''}</span> : <span className="text-slate-400 text-xs">-</span>}
                                                            </td>
                                                            <td className="px-6 py-4 text-right whitespace-nowrap">
                                                                <div className="flex justify-end space-x-3">
                                                                    <button onClick={() => generateIndividualPDF(student)} className="text-slate-500 hover:text-slate-900 transition-colors" title="Muat Turun PDF">
                                                                        <Download className="w-5 h-5"/>
                                                                    </button>
                                                                    <button onClick={() => handleEditClick(student)} className="text-blue-500 hover:text-blue-700 transition-colors" title="Edit Maklumat">
                                                                        <Edit className="w-5 h-5"/>
                                                                    </button>
                                                                    <button onClick={() => handleDeleteStudent(student.id)} className="text-red-400 hover:text-red-600 transition-colors" title="Padam Murid">
                                                                        <Trash2 className="w-5 h-5"/>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ); 
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'laporan' && (
                            <div className="space-y-8">
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div className="flex flex-wrap items-center gap-3 w-full md:w-auto">
                                        <div className="relative flex-1 md:w-40">
                                            <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                                <Filter className="w-4 h-4 text-slate-500" />
                                            </div>
                                            <select value={reportFilterYear} onChange={(e) => setReportFilterYear(e.target.value)} className="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-slate-500 focus:border-slate-500 block w-full pl-10 p-2.5">
                                                <option value="">Semua Tahun</option>
                                                {reportYearList.map(y => <option key={y} value={y}>{y}</option>)}
                                            </select>
                                        </div>
                                        <div className="relative flex-1 md:w-40">
                                            <select value={reportFilterClass} onChange={(e) => setReportFilterClass(e.target.value)} className="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-slate-500 focus:border-slate-500 block w-full p-2.5">
                                                <option value="">Semua Kelas</option>
                                                {reportClassList.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                        <div className="relative flex-1 md:w-40">
                                            <select value={reportFilterLevel} onChange={(e) => setReportFilterLevel(e.target.value)} className="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-slate-500 focus:border-slate-500 block w-full p-2.5">
                                                <option value="">Semua Tahap</option>
                                                <option value="Iqra">Iqra (1-6)</option>
                                                <option value="Al-Quran">Al-Quran</option>
                                                <option value="Khatam">Khatam</option>
                                            </select>
                                        </div>
                                    </div>

                                    <button onClick={generateFullReportPDF} className="flex items-center bg-slate-700 text-white px-5 py-2.5 rounded-lg shadow-sm hover:bg-slate-600 transition-colors font-medium text-sm w-full md:w-auto justify-center">
                                        <Printer className="w-4 h-4 mr-2"/> Cetak Laporan
                                    </button>
                                </div>

                                {/* KPI Cards - New Section */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <StatCard 
                                        title="Melepasi (Tahun 2-6)" 
                                        value={`${stats.kpi.pPass}%`} 
                                        subtitle={`${stats.kpi.pass} daripada ${stats.kpi.total} murid`}
                                        icon={ThumbsUp} 
                                        color="bg-green-100 text-green-700" 
                                    />
                                    <StatCard 
                                        title="Tidak Melepasi (Tahun 2-6)" 
                                        value={`${stats.kpi.pFail}%`} 
                                        subtitle={`${stats.kpi.fail} daripada ${stats.kpi.total} murid`}
                                        icon={ThumbsDown} 
                                        color="bg-red-100 text-red-700" 
                                    />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <StatCard title="Jumlah Murid Terpilih" value={stats.totalStudents} icon={Users} color="bg-slate-100 text-slate-600" />
                                    <StatCard title="Al-Quran" value={stats.dataByTahap.find(d => d.name === 'Al-Quran')?.value || 0} icon={BookOpen} color="bg-blue-100 text-blue-600" />
                                    <StatCard title="Khatam" value={stats.dataByTahap.find(d => d.name === 'Khatam')?.value || 0} icon={CheckCircle} color="bg-purple-100 text-purple-600" />
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-96">
                                        <h4 className="text-sm font-bold text-slate-500 uppercase mb-4">Statistik Tahap</h4>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={stats.dataByTahap} margin={{top: 20, right: 30, left: 20, bottom: 5}}>
                                                <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false}/>
                                                <XAxis dataKey="name" stroke="#64748b" fontSize={11} tickLine={false} axisLine={false} interval={0} angle={-45} textAnchor="end" height={60}/>
                                                <YAxis allowDecimals={false} stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'}} />
                                                <Bar dataKey="value" fill="#475569" radius={[4, 4, 0, 0]} barSize={30} />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-96">
                                        <h4 className="text-sm font-bold text-slate-500 uppercase mb-4">Taburan Juzuk</h4>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <LineChart data={stats.dataByJuzuk}>
                                                <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                                                <XAxis dataKey="juzuk" interval={4} stroke="#64748b" fontSize={12} tickLine={false} axisLine={false} />
                                                <YAxis allowDecimals={false} stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                <Tooltip contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'}} />
                                                <Line type="monotone" dataKey="count" stroke="#334155" strokeWidth={3} dot={{fill: '#334155', r: 3}} activeDot={{r: 6}} />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
